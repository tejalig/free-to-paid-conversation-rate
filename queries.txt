
### Descriptive Analysis

# Count the total number of records in the each table - student_engagement, student_info, student_purchases
select count(*) from db_course_conversions.student_engagement;
select count(*) from db_course_conversions.student_info;
select count(*) from db_course_conversions.student_purchases;

student_engagement
- student_id
- date_watched

student_info
- student_id
- date_registered

student_purchases
- purchase_id
- student_id
- date_purchased

### Answering business questions

## Conversion Funnel Analysis

# Registration to Engagement: What percentage of students who register actually watch a video? - result : 50.70

SELECT 
    ROUND(COUNT(DISTINCT se.student_id) * 100.0 / COUNT(DISTINCT si.student_id), 2) AS Percent_Engaged
FROM student_info si
LEFT JOIN student_engagement se 
    ON si.student_id = se.student_id;


# Engagement to Purchase: What percentage of students who watched a video ended up buying the course?

SELECT 
    COUNT(DISTINCT sp.student_id) * 100.0 / COUNT(DISTINCT se.student_id) AS Percent_Engagement_to_Purchase
FROM student_engagement se
LEFT JOIN student_purchases sp 
    ON se.student_id = sp.student_id;


# Total Conversion: What percentage of all registered students became paid customers?

SELECT COUNT(DISTINCT sp.student_id)*100.0/COUNT(DISTINCT si.student_id) AS Percent_Registered_to_Purchase
FROM student_info si
LEFT JOIN student_purchases sp
    ON si.student_id = sp.student_id;


### Time-to-Event Analysis
# Onboarding Speed: How many days pass between registration and the first time they watch a video?

SELECT 
    si.student_id, 
    si.date_registered, 
    MIN(se.date_watched) AS first_date_watched, 
    DATEDIFF(MIN(se.date_watched), si.date_registered) AS days_to_onboard
FROM student_info si
INNER JOIN student_engagement se 
    ON si.student_id = se.student_id
GROUP BY si.student_id, si.date_registered;


# Conversion Lag: How many days does it take a student to purchase after their first engagement?
SELECT 
    se.student_id, 
    MIN(se.date_watched) AS first_engagement, 
    MIN(sp.date_purchased) AS purchase_date,
    DATEDIFF(MIN(sp.date_purchased), MIN(se.date_watched)) AS days_to_purchase
FROM student_engagement se
INNER JOIN student_purchases sp 
    ON se.student_id = sp.student_id
GROUP BY se.student_id;

### Engagement Behavior

# Repeat Viewers: Do students who watch videos on multiple different days have a higher conversion rate than those who only watch once?
WITH user_behavior AS (
    SELECT 
        se.student_id,
        COUNT(DISTINCT se.date_watched) AS unique_days_watched,
        IF(COUNT(DISTINCT sp.purchase_id) > 0, 1, 0) AS made_purchase
    FROM student_engagement se
    LEFT JOIN student_purchases sp ON se.student_id = sp.student_id
    GROUP BY se.student_id
)
SELECT 
    CASE 
        WHEN unique_days_watched = 1 THEN 'Single Day Viewer' 
        ELSE 'Multi-Day Viewer'
    END AS viewer_type,
    ROUND(AVG(made_purchase) * 100, 2) AS conversion_rate
FROM user_behavior
GROUP BY 1;

# Popular Dates: Are there specific months or days where registration or purchasing activity spikes (seasonality)?
WITH monthly_stats AS (
    SELECT 
        YEAR(date_registered) AS year,
        MONTHNAME(date_registered) AS month_name, 
        COUNT(student_id) AS monthly_regs
    FROM student_info
    GROUP BY 1, 2
),
total_stats AS (
    SELECT COUNT(*) AS grand_total FROM student_info
)
SELECT 
    ms.year,
    ms.month_name,
    ms.monthly_regs,
    ROUND((ms.monthly_regs * 100.0) / ts.grand_total, 2) AS pct_contribution
FROM monthly_stats ms
CROSS JOIN total_stats ts
ORDER BY pct_contribution DESC;


# Lead Quality
# Free vs. Engaged: Are "Free" users who never engage more or less likely to convert later compared to those who engage immediately?

WITH user_segmentation AS (
    SELECT 
        si.student_id,
        -- Check if they ever watched a video
        CASE 
            WHEN se.student_id IS NULL THEN 'Passive (No Engagement)'
            ELSE 'Engaged (Watched Video)'
        END AS user_group,
        -- Check if they ever bought
        CASE 
            WHEN sp.student_id IS NULL THEN 0
            ELSE 1
        END AS made_purchase
    FROM student_info si
    LEFT JOIN (SELECT DISTINCT student_id FROM student_engagement) se 
        ON si.student_id = se.student_id
    LEFT JOIN (SELECT DISTINCT student_id FROM student_purchases) sp 
        ON si.student_id = sp.student_id
)
SELECT 
    user_group,
    COUNT(*) AS total_users,
    SUM(made_purchase) AS total_purchases,
    ROUND(AVG(made_purchase) * 100, 2) AS conversion_rate
FROM user_segmentation
GROUP BY user_group;
